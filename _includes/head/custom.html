<!-- Site icon -->
 <link rel="icon" href="/assets/images/logo.svg" type="image/svg+xml">
<link rel="icon" href="/assets/images/favicon.ico" sizes="any">

<!-- Custom head elements (kept minimal) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<!-- Prefetch Writing page  -->
<link rel="prefetch" href="/writing/">

<!-- Speed up OG card requests -->
<link rel="preconnect" href="https://api.microlink.io">
<link rel="dns-prefetch" href="https://api.microlink.io">

<style>
  :root { 
    --mm-font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
    /* Site width controls */
    --site-max: 760px;
    --site-pad: 24px;
  }
  /* Keep page background white */
  html, body { background: #fff; }

    article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section {
        display: contents;
    }

  /* Hide footer entirely */
  .page__footer { display: none !important; background: #fff !important; box-shadow: none !important; }
  .page__footer a { color: inherit !important; }

  /* Constrain and center main containers */
  .masthead__inner-wrap,

  .initial-content {
    max-width: var(--site-max);
    margin-left: auto;
    margin-right: auto;
    padding-left: var(--site-pad);
    padding-right: var(--site-pad);
  }

  /* Remove theme's extra inner padding so content aligns with site title */
  #main { padding-left: 0; padding-right: 0; }

  .page__inner-wrap {
    width: 100%;
    max-width: none;
    padding-left: 0;
    padding-right: 0;
  }
  
  .page__content { max-width: 100%; }

  /* Left-align title, meta and content so text starts under site title */
  .page__title,
  .page__meta,
  .page__content { text-align: left !important; }

  /* Ensure nav links and content respect the centered width */
  .greedy-nav { max-width: 100%; }

  /* Optional: avoid overly wide images/code blocks */
  .page__content img,
  .page__content pre,
  .page__content code,
  .page__content table { max-width: 100%; }

  /* Mobile keeps natural full width with padding */
  @media (max-width: 480px) {
    :root { --site-pad: 16px; }
  }

  /* OG link preview card styles */
  .og-card { 
    border: 1px solid #e5e7eb; 
    border-radius: 12px; 
    overflow: hidden; 
    background: #fff; 
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    margin: 12px 0; 
  }
  .og-card > a { 
    display: grid; 
    grid-template-columns: 160px 1fr; 
    gap: 0; 
    color: inherit; 
    text-decoration: none; 
  }
  .og-card__thumb {
    background-size: cover;
    background-position: center;
    min-height: 120px;
  }
  .og-card__body { 
    padding: 12px 14px; 
    display: grid; 
    align-content: start; 
    gap: 6px; 
  }
  .og-card__title { 
    font-weight: 600; 
    line-height: 1.3; 
    color: #111827; 
    overflow: hidden; 
    display: -webkit-box; 
    -webkit-line-clamp: 2; 
    line-clamp: 2;
    -webkit-box-orient: vertical; 
  }
  .og-card__desc { 
    font-size: 0.95rem; 
    color: #4b5563; 
    line-height: 1.4; 
    overflow: hidden; 
    display: -webkit-box; 
    -webkit-line-clamp: 3; 
    line-clamp: 3;
    -webkit-box-orient: vertical; 
  }
  .og-card__domain { 
    font-size: 0.85rem; 
    color: #6b7280; 
  }
  /* Tags row under each card */
  .og-card__tags { 
    margin-top: 2px; 
    display: flex; 
    flex-wrap: wrap; 
    gap: 6px; 
  }
  .og-chip { 
    border: 1px solid #e5e7eb; 
    background: #f8fafc; 
    color: #374151; 
    padding: 2px 8px; 
    border-radius: 9999px; 
    font-size: 0.8rem; 
    line-height: 1.6; 
    cursor: pointer; 
  }
  .og-chip:hover { 
    background: #eff6ff; 
    border-color: #dbeafe; 
    color: #1f2937; 
  }
  /* Filter chip styles */
  .og-filter__chip { font-weight: 500; }
  .og-filter__chip.--active { background: #111827; color: #fff; border-color: #111827; }

  /* Filter wrapper for multiple filter bars */
  .og-filters-wrapper {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
  }

  /* Filter toolbar */
  .og-filter {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    padding: 8px 10px;
    background: #fafafa;
    border: 1px solid #efefef;
    border-radius: 10px;
  }
  .og-filter__title { 
    font-weight: 600; 
    color: #374151; 
    margin-right: 4px; 
  }
  .og-filter__item { 
    display: inline-flex; 
    align-items: center; 
    gap: 6px; 
    padding: 2px 8px; 
    border-radius: 9999px; 
  }
  .og-filter__item.--active { 
    background: #f3f4f6; 
  }
  .og-filter__item input { 
    accent-color: #111827; 
  }
    /* Footer row: domain (left) + author (right) */
  .og-card__footer {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: 8px;
    margin-top: 6px;
  }
  .og-card__author {
    font-size: 0.85rem;
    color: #6b7280;
    text-align: right;
    white-space: nowrap;
  }
  .og-card__date {
    font-size: 0.85rem;
    color: #9ca3af;
    white-space: nowrap;
  }

  /* Compact layout when no image */
  .og-card.--noimg > a { grid-template-columns: 1fr; }
  .og-card.--noimg .og-card__body { padding: 14px; }

  @media (max-width: 600px) {
    .og-card > a { grid-template-columns: 120px 1fr; }
  }
</style>

<script>
  // Highlight current nav link (including Home/site-title) by adding .current
  document.addEventListener('DOMContentLoaded', function () {
    try {
      var normalize = function (p) {
        if (!p) return '/';
        // remove any index.html
        p = p.replace(/index\.html$/i, '');
        // ensure leading slash
        if (p[0] !== '/') p = '/' + p;
        // ensure trailing slash except root
        if (p !== '/' && !p.endsWith('/')) p += '/';
        return p;
      };

      var currentPath = normalize(window.location.pathname);
      var nav = document.getElementById('site-nav');
      if (!nav) return;

      var links = nav.querySelectorAll('a[href]');
      var matched = false;
      links.forEach(function (a) {
        try {
          var u = new URL(a.getAttribute('href'), window.location.origin);
          var hrefPath = normalize(u.pathname);
          if (hrefPath === currentPath) {
            a.classList.add('current');
            matched = true;
          }
        } catch (e) { /* ignore */ }
      });

      // If no match (e.g., a page not in menu) leave all unbolded.
      // Home will only be bold when on root via matching above.
    } catch (e) { /* noop */ }
  });
</script>

<script>
// Prefetch /writing/ on hover and when the browser is idle
document.addEventListener('DOMContentLoaded', function () {
  try {
    var think = document.querySelector('a[href="/writing/"]');
    if (think) {
      think.addEventListener('mouseenter', function () {
        var l = document.createElement('link'); l.rel = 'prefetch'; l.href = '/writing/'; document.head.appendChild(l);
      });
    }
    if ('requestIdleCallback' in window) {
      requestIdleCallback(function(){ var l = document.createElement('link'); l.rel='prefetch'; l.href='/writing/'; document.head.appendChild(l); });
    }
  } catch (e) { /* noop */ }
});
</script>

<script>
  // Map exact URLs (preferably without query) or hostnames to local assets under /assets/og/
  // Example:
  // window.OG_IMAGE_OVERRIDES = {
  //   'https://docs.google.com/presentation/d/e/2PACX-1vRpbygPjpPH1dG14ZbKt-al-DOltYoxbDI6YcnXmc-ufH0GI56ENECrLE1kQScFXKSIHTHdbeImhvC7/pub': '/assets/og/intro-to-kubernetes.png',
  //   'medium.com': '/assets/og/medium.png'
  // };
  window.OG_IMAGE_OVERRIDES = window.OG_IMAGE_OVERRIDES || {};

  // Optional author overrides. Map exact URLs or hostnames to an author string.
  // Example:
  // window.OG_AUTHOR_OVERRIDES = {
  //   'https://example.com/some-post': 'Jane Doe',
  //   'medium.com': 'Medium Author'
  // };
  window.OG_AUTHOR_OVERRIDES = window.OG_AUTHOR_OVERRIDES || {};
</script>

<script>
  // Local OG cache data from Jekyll
  window.OG_CACHE = {
    {% for card in site.data.og_cache.cards %}
    {{ card[0] | jsonify }}: {
      title: {{ card[1].title | jsonify }},
      description: {{ card[1].description | jsonify }},
      image: {{ card[1].image | jsonify }},
      domain: {{ card[1].domain | jsonify }},
      author: {{ card[1].author | jsonify }}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  };
</script>

<script>
  // Notion-like link preview cards using hybrid cache + API approach
  document.addEventListener('DOMContentLoaded', function () {
    try {
      // Only run on the Writing page (permalink /writing/)
      if (!/\/writing\/?$/.test(location.pathname)) return;

      var anchors = Array.from(document.querySelectorAll('a.og-embed, [data-og-embed]'));
      if (!anchors.length) return;

      // Upfront tags and categories collection so we can render filter bars immediately
      var allTags = new Set();
      var allCategories = new Set();
      anchors.forEach(function (el) {
        var rawTags = (el.getAttribute('data-tags') || '').trim();
        var tagsArr = rawTags
          ? rawTags.split(/[,]+/).map(function (t) { return t.replace(/^#/, '').trim(); }).filter(Boolean)
          : [];
        el.__ogTags = tagsArr; // store on element for later
        tagsArr.forEach(function (t) { allTags.add(t); });

        var category = (el.getAttribute('data-category') || '').trim();
        if (category) {
          el.__ogCategory = category;
          allCategories.add(category);
        }
      });

      var container = document.querySelector('.page__content') || document.getElementById('main') || document.body;

      // Override resolver (per-link attribute or global map)
      function normalizeUrl(u) {
        try { var x = new URL(u, location.origin); x.hash=''; x.search=''; return x.toString(); }
        catch(e){ return u; }
      }
      function resolveImgOverride(u, el) {
        // Per-link attribute wins
        var attr = (el && (el.getAttribute('data-image') || el.getAttribute('data-og-image')));
        if (attr) return attr;

        var map = (window.OG_IMAGE_OVERRIDES || {});
        var urlObj; try { urlObj = new URL(u, location.origin); } catch(e){}

        // Exact URL without query/hash
        var exact = map[normalizeUrl(u)];
        if (exact) return exact;

        if (urlObj) {
          var noQuery = urlObj.origin + urlObj.pathname;
          if (map[noQuery]) return map[noQuery];
          if (map[urlObj.hostname]) return map[urlObj.hostname];
        }
        return null;
      }

      // Resolve author overrides (per-link attribute or global map)
      function resolveAuthorOverride(u, el) {
        // Per-link attribute wins
        var attr = (el && (el.getAttribute('data-author') || el.getAttribute('data-og-author')));
        if (attr) return attr;

        var map = (window.OG_AUTHOR_OVERRIDES || {});
        var urlObj; try { urlObj = new URL(u, location.origin); } catch(e){}

        // Exact URL without query/hash
        var exact = map[normalizeUrl(u)];
        if (exact) return exact;

        if (urlObj) {
          var noQuery = urlObj.origin + urlObj.pathname;
          if (map[noQuery]) return map[noQuery];
          if (map[urlObj.hostname]) return map[urlObj.hostname];
        }
        return '';
      }


      // Build card DOM
      var toCard = function(meta, url, tags, overrideImage, overrideAuthor, dateStr, category) {
        var title = (meta && (meta.title || (meta.data && meta.data.title))) || url;
        var desc = (meta && (meta.description || (meta.data && meta.data.description))) || '';
        // Prefer override image when provided
        var image = overrideImage ||
                    (meta && (meta.image && (meta.image.url || meta.image))) ||
                    (meta && meta.data && meta.data.image && (meta.data.image.url || meta.data.image));
        var domain = (function(u){ try { return new URL(u).hostname.replace(/^www\./,''); } catch(e) { return ''; } })(url);
        var author = overrideAuthor || (meta && (meta.author || (meta.data && meta.data.author))) || '';
        var displayTags = (tags || []).map(function(t){ return t; });
        var storeTags = displayTags.map(function(t){ return t; });

        var card = document.createElement('div');
        card.className = 'og-card' + (image ? '' : ' --noimg');
        if (storeTags.length) card.dataset.tags = storeTags.join(',');
        if (category) card.dataset.category = category;

        var a = document.createElement('a');
        a.href = url; a.target = '_blank'; a.rel = 'noopener';

        if (image) {
          var thumb = document.createElement('div');
          thumb.className = 'og-card__thumb';
          thumb.style.backgroundImage = 'url("' + image + '")';
          a.appendChild(thumb);
        }

        var body = document.createElement('div');
        body.className = 'og-card__body';
        var t = document.createElement('div'); t.className = 'og-card__title'; t.textContent = title; body.appendChild(t);
        if (desc) { var d = document.createElement('div'); d.className = 'og-card__desc'; d.textContent = desc; body.appendChild(d); }
        // if (domain) { var dm = document.createElement('div'); dm.className = 'og-card__domain'; dm.textContent = domain; body.appendChild(dm); }


        if (displayTags.length) {
          var tagsWrap = document.createElement('div');
          tagsWrap.className = 'og-card__tags';
          displayTags.forEach(function(tag, idx) {
            var chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'og-chip';
            chip.dataset.tag = storeTags[idx] || tag;
            chip.textContent = tag;
            tagsWrap.appendChild(chip);
          });
          body.appendChild(tagsWrap);
        }

        // Footer with category + domain (left) and date/author (right)
        if (domain || author || dateStr || category) {
          var footer = document.createElement('div');
          footer.className = 'og-card__footer';
          var leftSide = document.createElement('div'); leftSide.className = 'og-card__domain';
          var leftParts = [category, domain].filter(Boolean);
          leftSide.textContent = leftParts.join(' Â· ');
          var rightSide = document.createElement('div'); rightSide.className = 'og-card__author';
          var rightParts = [dateStr, author].filter(Boolean);
          rightSide.textContent = rightParts.join(' Â· ');
          footer.appendChild(leftSide);
          footer.appendChild(rightSide);
          body.appendChild(footer);
        }

        a.appendChild(body);
        card.appendChild(a);
        return card;
      };


      // Hybrid cache + API fetch for OG meta
      var fetchMeta = function(url) {
        // First, check local cache
        var cached = window.OG_CACHE && window.OG_CACHE[url];
        if (cached) {
          console.log('âœ… Cache hit for:', url);
          return Promise.resolve({
            title: cached.title,
            description: cached.description,
            image: cached.image,
            author: cached.author,
            data: {
              title: cached.title,
              description: cached.description,
              image: cached.image,
              author: cached.author
            }
          });
        }

        // Fallback to API if not in cache
        console.log('ðŸŒ Cache miss, fetching from API:', url);
        var api = 'https://api.microlink.io?audio=false&video=false&iframe=false&palette=false&url=' + encodeURIComponent(url);
        var ctrl = (window.AbortController ? new AbortController() : null);
        var timer = setTimeout(function(){ if (ctrl) ctrl.abort(); }, 6000);

        return fetch(api, { mode: 'cors', signal: ctrl && ctrl.signal })
          .then(function(r){ if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
          .then(function(res){
            var data = (res && (res.data || res));
            console.log('ðŸ“¡ API response for:', url, data);
            return data;
          })
          .finally(function(){ clearTimeout(timer); });
      };

      // Filter state
      var currentTagFilter = '';
      var currentCategoryFilter = '';

      // Filter logic
      var applyFilters = function() {
        var cards = Array.from(container.querySelectorAll('.og-card'));
        cards.forEach(function(card){
          var tags = (card.dataset.tags || '').split(',').filter(Boolean);
          var category = card.dataset.category || '';
          var tagMatch = !currentTagFilter || tags.includes(currentTagFilter);
          var catMatch = !currentCategoryFilter || category === currentCategoryFilter;
          card.style.display = (tagMatch && catMatch) ? '' : 'none';
        });
        // Update tag filter chips
        var tagChips = container.querySelectorAll('.og-filter--tags .og-filter__chip');
        tagChips.forEach(function(chip){
          var val = (chip.dataset.tag || '');
          if (val === currentTagFilter) chip.classList.add('--active'); else chip.classList.remove('--active');
        });
        // Update category filter chips
        var catChips = container.querySelectorAll('.og-filter--category .og-filter__chip');
        catChips.forEach(function(chip){
          var val = (chip.dataset.category || '');
          if (val === currentCategoryFilter) chip.classList.add('--active'); else chip.classList.remove('--active');
        });
      };

      // Insert filter bars immediately (no need to wait for fetches)
      var insertFilterBars = function() {
        var wrapper = document.createElement('div');
        wrapper.className = 'og-filters-wrapper';

        // Category filter (Article, Presentation, Notes)
        var categories = ['Article', 'Presentation', 'Notes'];
        var catFilter = document.createElement('div');
        catFilter.className = 'og-filter og-filter--category';

        var makeCatChip = function(label, value, active) {
          var chip = document.createElement('button');
          chip.type = 'button';
          chip.className = 'og-chip og-filter__chip' + (active ? ' --active' : '');
          chip.dataset.category = (value || '');
          chip.textContent = label;
          return chip;
        };

        catFilter.appendChild(makeCatChip('All', '', true));
        categories.forEach(function(cat){ catFilter.appendChild(makeCatChip(cat, cat, false)); });
        wrapper.appendChild(catFilter);

        // Tag filter
        if (allTags.size) {
          var tags = Array.from(allTags).sort();
          var tagFilter = document.createElement('div');
          tagFilter.className = 'og-filter og-filter--tags';

          var makeTagChip = function(label, value, active) {
            var chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'og-chip og-filter__chip' + (active ? ' --active' : '');
            chip.dataset.tag = (value || '');
            chip.textContent = label;
            return chip;
          };

          tagFilter.appendChild(makeTagChip('All', '', true));
          tags.forEach(function(tag){ tagFilter.appendChild(makeTagChip(tag, tag, false)); });
          wrapper.appendChild(tagFilter);
        }

        if (container.firstChild) container.insertBefore(wrapper, container.firstChild);
        else container.appendChild(wrapper);

        // Click to filter via category chips
        wrapper.addEventListener('click', function(e){
          var chip = e.target.closest ? e.target.closest('.og-filter--category .og-filter__chip') : null;
          if (chip) {
            currentCategoryFilter = chip.dataset.category || '';
            applyFilters();
          }
        });

        // Click to filter via tag chips
        wrapper.addEventListener('click', function(e){
          var chip = e.target.closest ? e.target.closest('.og-filter--tags .og-filter__chip') : null;
          if (chip) {
            currentTagFilter = chip.dataset.tag || '';
            applyFilters();
          }
        });

        // Clicking a card chip sets the tag filter
        container.addEventListener('click', function(e){
          var chip = e.target.closest ? e.target.closest('.og-card .og-chip') : null;
          if (chip && chip.dataset && chip.dataset.tag) {
            if (e.preventDefault) e.preventDefault();
            if (e.stopPropagation) e.stopPropagation();
            currentTagFilter = chip.dataset.tag;
            applyFilters();
          }
        });
      };

      insertFilterBars();

      // Concurrency-limited processing of anchors
      var MAX_CONCURRENCY = 6;
      var i = 0;

      function worker() {
        if (i >= anchors.length) return Promise.resolve();
        var el = anchors[i++];
        var url = el.getAttribute('href') || el.getAttribute('data-og-embed');
        var tagsArr = el.__ogTags || [];
        if (!url) return worker();

        // Use per-link or global override if available
        var overrideImg = resolveImgOverride(url, el);
        var overrideAuthor = resolveAuthorOverride(url, el);
        var dateStr = el.getAttribute('data-date') || '';
        var category = el.__ogCategory || '';

        return fetchMeta(url).then(function(meta){
          var card = toCard(meta, url, tagsArr, overrideImg, overrideAuthor, dateStr, category);
          el.replaceWith(card);
        }).catch(function(){
          // If fetch fails but we have an override, still render a card
          if (overrideImg) {
            var card = toCard({}, url, tagsArr, overrideImg, overrideAuthor, dateStr, category);
            el.replaceWith(card);
            return;
          }
          // Fallback: keep original link; still add data-tags for filtering
          if (tagsArr.length) el.setAttribute('data-tags', tagsArr.join(','));
        }).then(worker);
      }

      Promise.all(Array.from({ length: Math.min(MAX_CONCURRENCY, anchors.length) }, worker));
    } catch (e) { /* ignore */ }
  });
</script>

<!-- MathJax configuration for LaTeX rendering -->
{% if page.mathjax or site.mathjax %}
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
{% endif %}